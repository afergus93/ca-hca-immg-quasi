---
title: "WA_Can_HCA_Tbl1/2"
author: "Daniel Cockson"
date: "5/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory
setwd("C:/wa-cannabis-hca")

# Clear workspace 
rm(list = ls())

# Load required libraries 
library(survey)
library(epiR)
library(tidyverse)
library(foreign)
library(haven)
library(table1)
library(kableExtra)
library(gtsummary)
library(gt)
library(broom)

# Read in the cleaned data
df <- read.csv("data/WA_2015_2019_BRFSS_Clean.csv")

```

```{r}
#### Creating Labels for each variable ####

# Creating age label
label(df$X_age_g) <- "Age group (yrs)"

# Creating gender label 
label(df$sex) <- "Gender"

# Creating race label
label(df$race) <- "Race/Ethnicity"

# Creating education label
label(df$edu) <- "Education"

# Creating income label 
label(df$income_wa) <- "Household Income"

# Creating health insurance label
label(df$hlthpln1) <- "No health coverage"

# Creating health cost label
label(df$medcost) <- "Delay medical care due to cost in past year"

# Creating mental health label
label(df$mentComp) <- "Poor mental health in past month"

# Creating alcohol consumption label
label(df$curAlc) <- "Alcohol consumption"

# Creating smoking status label
label(df$curSmk) <- "Tobacco smoking status"

# Creating cannabis usage label
label(df$mj30day) <- "Cannabis use in past month"

```

```{r}

db <- svydesign(
  id = ~1,
  strata = ~X_ststr,
  weights = ~X_llcpwt,
  data = df, 
  nest = TRUE) 

# main table 1 by current vs non-current cannabis use 
t1 <- tbl_svysummary(db, by = mj30day, 
               include = c(X_age_g, sex, race, edu, income_wa, hlthpln1, medcost, mentComp, curAlc, curSmk),
               statistic = list(everything() ~ "{n_unweighted} ({p}%)")) %>%
  modify_header(stat_by = "**{level}**, N={n_unweighted}") %>%
  add_overall(last = TRUE, col_label = "**Total**, N={N_unweighted}") %>%
  modify_caption("**Table 1. Past Month Cannabis User Characteristics**") %>%
  bold_labels()

t1 %>%
  as_gt() %>%
  gtsave("Table1_CA_WA.html")

# alternative table 1's for demographic exploration
t1.alt.medcost <- tbl_svysummary(db, by = medcost, 
               include = c(X_age_g, sex, race, edu, income_wa, hlthpln1, mj30day, mentComp, curAlc, curSmk),
               statistic = list(everything() ~ "{n_unweighted} ({p}%)")) %>%
  modify_header(stat_by = "**{level}**, N={n_unweighted}") %>%
  add_overall(last = TRUE, col_label = "**Total**, N={N_unweighted}") %>%
  modify_caption("**Table 1Alt. dHCA Characteristics**") %>%
  bold_labels()


t1.alt.ment14d <- tbl_svysummary(db, by = mentComp, 
               include = c(X_age_g, sex, race, edu, income_wa, hlthpln1, mj30day, medcost, curAlc, curSmk),
               statistic = list(everything() ~ "{n_unweighted} ({p}%)")) %>%
  modify_header(stat_by = "**{level}**, N={n_unweighted}") %>%
  add_overall(last = TRUE, col_label = "**Total**, N={N_unweighted}") %>%
  modify_caption("**Table 1Alt. dHCA Characteristics**") %>%
  bold_labels()

```

```{r}
# create an empty dataframe for the adjusted PR's
adj.PR <- NULL

# Find the crude PR
adj.PR <- rbind(adj.PR,
                tidy(epi.2by2(table(df$mentComp, df$mj30day), method = "cross.sectional")) %>%
                  filter(term == "PR.strata.wald"))

# make a list of all the levels of exposure and covariates to examine
covariates <- c("sex", "X_age_g", "race", "edu", "income_wa", "medcost", "hlthpln1", "curAlc", "curSmk")

# nested for loop
for (y in covariates) { # For each covariate in the covariate list
  adj.PR <- rbind(adj.PR, # Create a new row for each covariate
                  tidy(epi.2by2(table(df$mentComp, df$mj30day, df[, y]), method = "cross.sectional")) %>%
                    filter(term == "PR.mh.wald")) # Find the PR for the mh adjustment
}

# Assign variables to new column
row.labels <- c("Crude", "Sex", "Age", "Race/Ethnicity", "Education", "Income", "Difficulty affording care", "Health coverage", "Current alcohol use", "Current tobacco smoking status")

for (i in 1:10) {
  adj.PR[i,1] <- row.labels[i] # assign the label column with the correct variable name
}

```

```{r}
# Creating the table 2

adj.PR <- adj.PR %>%
  gt(rowname_col = "term", groupname_col = "Characteristic") %>%  
  fmt_number(
    columns = 2:4,
    decimals = 2
  ) %>%
  tab_header(
    title = md("Table 2: Prevalance Ratios of Cannabis Usage"),
    subtitle = md("14+ Poor Mental Health Days vs. 0-13 Days of Poor Mental Health Days")) %>%
  tab_spanner(label = "95% Confidence Interval", columns = c(conf.low, conf.high)) %>%
  cols_label(
    estimate = "Prevalance Ratio",
    conf.low = "Lower",
    conf.high = "Upper")

# Save the table
adj.PR %>%
  gtsave("Table2_CA_WA.html")

```



