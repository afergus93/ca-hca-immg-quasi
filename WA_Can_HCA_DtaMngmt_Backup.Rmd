---
title: "WA_Can_HCA_DtaMngmt"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory
setwd("C:/wa-cannabis-hca")

# Clear workspace 
rm(list = ls())

# Load required libraries 
library(survey)
library(epiR)
library(tidyverse)
library(foreign)
library(haven)
library(table1)
library(kableExtra)
library(gtsummary)
library(gt)

```


```{r}
#### Load in the WA-BRFSS Data ####

# WRITING THE TEMP FILE IS ONLY NECCESARY IF YOU DO NOT HAVE THE FILE IN CSV FORMAT

# Read in the data as dta
temp <- read_dta('data/MAS_2011_2020_v2.dta') %>%
    subset(year > 2014 & year < 2020) # Years of interest given variable avail. are 2015 - 2019

# Find the proportion of observations in each year
tc <- table(temp$year) %>%
  prop.table() # get the proportion of each year's observations 

temp$'_llcpwt'[temp$year == 2015] <- temp$'_llcpwt'[temp$year == 2015] * tc[1] # Re-weighting 2015
temp$'_llcpwt'[temp$year == 2016] <- temp$'_llcpwt'[temp$year == 2016] * tc[2] # Re-weighting 2016
temp$'_llcpwt'[temp$year == 2017] <- temp$'_llcpwt'[temp$year == 2017] * tc[3] # Re-weighting 2017
temp$'_llcpwt'[temp$year == 2018] <- temp$'_llcpwt'[temp$year == 2018] * tc[4] # Re-weighting 2018
temp$'_llcpwt'[temp$year == 2019] <- temp$'_llcpwt'[temp$year == 2019] * tc[5] # Re-weighting 2019

# Re-write the file as a csv
write.csv(temp, 'data/WA_2015_2019_BRFSS.csv')

#Remove the dta file
rm(temp)

# Read in the newly created csv file for desired vars
full <- read.csv("data/WA_2015_2019_BRFSS.csv", stringsAsFactors = F) %>%
  select(year,
         zipcode,
         zipcode1,
         X_ststr,
         X_llcpwt,
         sex,
         X_age_g,
         X_mrace1,
         X_hispanc,
         educa,
         employ1,
         X_incomg,
         X_smoker3,
         alcday5,
         menthlth,
         hlthpln1,
         medcost,
         mjpast30,
         mj30day
         ) %>%
  subset(X_age_g < 6) # Removing individuals over 65 due to Medicare eligibility 

# *Optional* Write to new file for memory efficiency 
write.csv(full, "data/WA_2015_2019_BRFSS_Sub.csv")
rm(list = ls())
df <- read.csv("data/WA_2015_2019_BRFSS_Sub.csv")
df$X <- NULL
# summary(df)

```

```{r}
#### Assigning NA Values ####

# Assigning the values of 7 or 9 "refusal" to NA within sex variable
df$sex[df$sex == 7 | df$sex == 9] <- NA

# Assigning the value of 9 to NA within the race variable
df$X_mrace1[df$X_mrace1 == 77 | df$X_mrace1 == 99] <- NA

# Assigning the value of 9 to NA within the Eth variable
df$X_hispanc[df$X_hispanc == 9] <- NA

# Assigning the value of 9 to NA within the edu. variable
df$educa[df$educa == 9] <- NA

# Assigning the value of 9 to NA within the employment variable
df$employ1[df$employ1 == 9] <- NA

# Assigning the value of 77 and 99 to NA within the income variable
df$X_incomg[df$X_incomg == 9] <- NA

# Assigning the value of 9 to NA within the mental health variable
df$menthlth[df$menthlth == 77 | df$menthlth == 99] <- NA

# Assigning the value of 7 and 9 to NA within the insurance variable
df$hlthpln1[df$hlthpln1 == 7 | df$hlthpln1 == 9] <- NA

# Assigning the value of 7 and 9 to NA within the medical cost variable
df$medcost[df$medcost == 7 | df$medcost == 9] <- NA

# Assigning the value of 7 and 9 to NA within the smoking variable
df$X_smoker3[df$X_smoker3 == 9] <- NA

# Assigning the value of 777 and 999 to NA within the alc. variable
df$alcday5[df$alcday5 == 777 | df$alcday5 == 999] <- NA

# Assigning the value of 77 and 99 to NA within the cannabis variable
df$mj30day[df$mj30day == 7 | df$mj30day == 9] <- NA

# Assigning the value of 77 and 99 to NA within the cannabis variable
df$mjpast30[df$mjpast30 == 77 | df$mjpast30 == 99] <- NA

# summary(df)

#  barplot(table(df$menthlth))
#  barplot(table(df$mjpast30))
#  
#  testdf <- subset(df, mjpast30 != 88)
#  barplot(table(testdf$mjpast30))
#  
# testdf <- subset(df, menthlth != 88)
# barplot(table(testdf$menthlth))

```

```{r}
#### Dropping All Observations Where MJ or HCA is NA ####

df <- df %>%
  filter(!is.na(mj30day) & !is.na(medcost) & !is.na(menthlth)) %>% # filter out any missingness associated with exposure/outcome
  rename(zipcodeTemp1 = zipcode, zipcodeTemp2 = zipcode1) %>% # Rename zipcode variables
  mutate(zipcode = coalesce(zipcodeTemp1, zipcodeTemp2)) %>% # Combine the zipcode variables across the two columns
  select(-c(zipcodeTemp1, zipcodeTemp2)) %>% # Drop old zipcode variables
  select(zipcode, everything()) # Move updated variable to the beginning of the dataframe

# summary(df)

# Recoding mental health variable 
df$ment14d[df$menthlth == 88] <- 3 # No poor mental health days in the past 30 days
df$ment14d[df$menthlth >= 1 & df$menthlth <= 13] <- 2 # Between 1 and 13 days of poor mental health in past 30 days
df$ment14d[df$menthlth > 13 & df$menthlth <= 30] <- 1 # Between 13 and 30 days of poor mental health in past 30 days

# Recoding tobacco usage variable
df$curSmk[df$X_smoker3 == 1 | df$X_smoker3 == 2] <- 1 # Values 1 and 2 correspond to current smoker
df$curSmk[df$X_smoker3 == 3 | df$X_smoker3 == 4] <- 2 # Either a former smoker or never smoked
df$curSmk[is.na(df$X_smoker3)] <- NA

# Recoding the alc usage variable
df$curAlc[df$alcday5 > 100 & df$alcday5 < 108] <- 1 # Consumed alcohol in the past week
df$curAlc[df$alcday5 > 200 & df$alcday5 < 231] <- 2 # Consumed alcohol in the past month
df$curAlc[df$alcday5 == 888] <- 3 # Consumed no alcohol in past 30 days
df$curAlc[is.na(df$alcday5)] <- NA

# Recoding current smoker + current alc usage
df$curAlcSmk[df$curSmk == 1 & (df$curAlc == 1 | df$curAlc == 2)] <- 1
df$curAlcSmk[df$curSmk == 2 | df$curAlc == 3] <- 2
df$curAlcSmk[is.na(df$curAlc) | is.na(df$curSmk)] <- NA

# Recoding the Education Variable
df$edu[df$educa < 4] <- 1 # Did not graduate high school
df$edu[df$educa == 4] <- 2 # Graduated high school
df$edu[df$educa == 5] <- 3 # Some college or tech school
df$edu[df$educa == 6] <- 4 # Graduated from college/tech school
df$edu[is.na(df$educa)] <- NA

# Creating new Race/Eth. variable
df$race[df$X_mrace1 == 4 & df$X_hispanc != 1] <- 1 # Non-hispanic Asian
df$race[df$X_mrace1 == 2 & df$X_hispanc != 1] <- 2 # Non-hispanic Black or African American
df$race[df$X_hispanc == 1] <- 3 # Hispanic/Latino/a
df$race[df$X_mrace1 == 7 & df$X_hispanc != 1] <- 4 # Non-hispanic Multiracial
df$race[df$X_mrace1 == 6 & df$X_hispanc != 1] <- 5 # Non-hispanic Native American
df$race[df$X_mrace1 == 3 & df$X_hispanc != 1] <- 6 # Non-hispanic other race
df$race[df$X_mrace1 == 5 & df$X_hispanc != 1] <- 7 # Non-hispanic Pacific Islander
df$race[df$X_mrace1 == 1 & df$X_hispanc != 1] <- 8 # Non-hispanic White
df$race[is.na(df$X_mrace1) & is.na(df$X_hispanc)] <- NA

```

```{r}
#### Factoring Variables #### 

# Gender Factor
df$sex <- factor(df$sex,
                 levels = c(1,2),
                 labels = c("Male", "Female"),
                 exclude = NULL)

# Education Factor  CREATE NEW VARIABLE
df$edu <- factor(df$edu,
                   levels = c(1,2,3,4),
                   labels = c("Did not graduate high school",
                              "High school graduate",
                              "Some college or tech school",
                              "Graduated college or tech school"),
                   exclude = NULL)

# Race Factor
df$race <- factor(df$race,
                   levels = c(1,2,3,4,5,6,7,8),
                   labels = c("Non-Hispanic Asian",
                              "Non-Hispanic Black or African American",
                              "Hispanic, Latino/a, or Spanish origin",
                              "Non-Hispanic two or more races",
                              "Non-Hispanic Native American",
                              "Non-Hispanic Other race",
                              "Non-Hispanic Pacific Islander",
                              "Non-Hispanic White"),
                   exclude = NULL)

# Age Factors
df$X_age_g <- factor(df$X_age_g, 
                       levels = c(1,2,3,4,5),
                       labels = c("18-24", "25-34",
                                  "35-44", "45-54",
                                  "55-64"),
                       exclude = NULL)

# Employment Factors
df$employ1 <- factor(df$employ1,
                     levels = c(1,2,3,4,5,6,7,8),
                     labels = c("Employed for wages", "Self-employed",
                                "Out of work for 1 year or more", "Out of work < 1 year",
                                "A homemaker", "A student", "Retired", "Unable to work"),
                     exclude = NULL)

# Income Factors CREATE NEW VARIABLE
df$X_incomg <- factor(df$X_incomg,
                     levels = c(1,2,3,4,5),
                     labels = c("< $15,000", "$15,000-$24,999", "$25,000-$34,999",
                                "$35,000-$49,999", "> $50,000"),
                     exclude = NULL)

# Currant Smoker Factors
df$curSmk <- factor(df$curSmk,
                      levels = c(1,2),
                      labels = c("Current smoker", "Non-smoker"),
                      exclude = NULL)

# Current Alc. Factors
df$curAlc <- factor(df$curAlc,
                      levels = c(1,2,3),
                      labels = c("Within past week", "Within past month", "None in past month"),
                      exclude = NULL)

# Current Alc. Factors
df$curAlcSmk <- factor(df$curAlcSmk,
                      levels = c(1,2),
                      labels = c("Yes", "No"),
                      exclude = NULL)

# Mental Health Factors
df$ment14d <- factor(df$ment14d,
                      levels = c(1,2,3),
                      labels = c("14+ days", "1-14 days", "No days"),
                      exclude = NULL)

# Health Insurance Factor
df$hlthpln1 <- factor(df$hlthpln1,
                      levels = c(2,1),
                      labels = c("Yes", "No"),
                      exclude = NULL)

# Med Cost Factor
df$medcost <- factor(df$medcost,
                      levels = c(1,2),
                      labels = c("Yes", "No"),
                      exclude = NULL)

# Cannabis Use Factor
df$mj30day <- factor(df$mj30day,
                      levels = c(1,2),
                      labels = c("Cannabis use in past month", "No cannabis use in past month"),
                      exclude = NULL)

```

```{r}
#### Creating Labels for each variable ####

# Creating age label
label(df$X_age_g) <- "Age group (yrs)"

# Creating gender label 
label(df$sex) <- "Gender"

# Creating race label
label(df$race) <- "Race/Ethnicity"

# Creating education label
label(df$edu) <- "Education"

# Creating income label 
label(df$X_incomg) <- "Income"

# Creating health insurance label
label(df$hlthpln1) <- "No health coverage"

# Creating health cost label
label(df$medcost) <- "Delay medical care due to cost in past year"

# Creating mental health label
label(df$ment14d) <- "Poor mental health in past month"

# Creating alcohol consumption label
label(df$curAlc) <- "Alcohol consumption"

# Creating smoking status label
label(df$curSmk) <- "Tobacco smoking status"

# Creating cannabis usage label
label(df$mj30day) <- "Cannabis use in past month"

```

```{r}

db <- svydesign(
  id = ~1,
  strata = ~X_ststr,
  weights = ~X_llcpwt,
  data = df, 
  nest = TRUE) 

# main table 1 by current vs non-current cannabis use 
t1 <- tbl_svysummary(db, by = mj30day, 
               include = c(X_age_g, sex, race, edu, X_incomg, hlthpln1, medcost, ment14d, curAlc, curSmk),
               statistic = list(everything() ~ "{n_unweighted} ({p}%)")) %>%
  modify_header(stat_by = "**{level}**, N={n_unweighted}") %>%
  add_overall(last = TRUE, col_label = "**Total**, N={N_unweighted}") %>%
  modify_caption("**Table 1. Past Month Cannabis User Characteristics**") %>%
  bold_labels()

t1 %>%
  as_gt() %>%
  gtsave("Table1_CA_WA.html")

# alternative table 1's for demographic exploration
t1.alt.medcost <- tbl_svysummary(db, by = medcost, 
               include = c(X_age_g, sex, race, edu, X_incomg, hlthpln1, mj30day, ment14d, curAlc, curSmk),
               statistic = list(everything() ~ "{n_unweighted} ({p}%)")) %>%
  modify_header(stat_by = "**{level}**, N={n_unweighted}") %>%
  add_overall(last = TRUE, col_label = "**Total**, N={N_unweighted}") %>%
  modify_caption("**Table 1Alt. dHCA Characteristics**") %>%
  bold_labels()


t1.alt.ment14d <- tbl_svysummary(db, by = ment14d, 
               include = c(X_age_g, sex, race, edu, X_incomg, hlthpln1, mj30day, medcost, curAlc, curSmk),
               statistic = list(everything() ~ "{n_unweighted} ({p}%)")) %>%
  modify_header(stat_by = "**{level}**, N={n_unweighted}") %>%
  add_overall(last = TRUE, col_label = "**Total**, N={N_unweighted}") %>%
  modify_caption("**Table 1Alt. dHCA Characteristics**") %>%
  bold_labels()

```

```{r}
#### Stratifying by sex ####
sex.strat.over <- with(df, 
                       table(ment14d, mj30day, sex))
sex.strat.m <- with(subset(df, sex == "Male"),
                    table(ment14d, mj30day))
sex.strat.f <- with(subset(df, sex == "Female"),
                    table(ment14d, mj30day))

b <- epi.2by2(sex.strat.over, method = "cross.sectional")
c <- epi.2by2(sex.strat.m, method = "cross.sectional")
d <- epi.2by2(sex.strat.f, method = "cross.sectional")

```

```{r}
### Stratifying by age ####
age.strat.over <- with(df,
                       table(ment14d, mj30day, X_age_g))
age.strat.18 <- with(subset(df, X_age_g == "18-24"),
                     table(ment14d, mj30day))
age.strat.25 <- with(subset(df, X_age_g == "25-34"),
                     table(ment14d, mj30day))
age.strat.35 <- with(subset(df, X_age_g == "35-44"),
                     table(ment14d, mj30day))
age.strat.45 <- with(subset(df, X_age_g == "45-54"),
                     table(ment14d, mj30day))
age.strat.55 <- with(subset(df, X_age_g == "55-64"),
                     table(ment14d, mj30day))

epi.2by2(age.strat.over, method = "cross.sectional")
epi.2by2(age.strat.18, method = "cross.sectional")
epi.2by2(age.strat.25, method = "cross.sectional")
epi.2by2(age.strat.35, method = "cross.sectional")
epi.2by2(age.strat.45, method = "cross.sectional")
epi.2by2(age.strat.55, method = "cross.sectional")

```

```{r}
#### Stratifying by edu. ####
edu.strat.overall <- with(df,
                          table(ment14d, mj30day, edu))
edu.strat.nhs <- with(subset(df, edu == "Did not graduate high school"),
                      table(ment14d, mj30day))
edu.strat.hs <- with(subset(df, edu == "High school graduate"),
                      table(ment14d, mj30day))
edu.strat.sc <- with(subset(df, edu == "Some college or tech school"),
                      table(ment14d, mj30day))
edu.strat.cg <- with(subset(df, edu == "Graduated college or tech school"),
                      table(ment14d, mj30day))

epi.2by2(edu.strat.overall, method = "cross.sectional")
epi.2by2(edu.strat.nhs, method = "cross.sectional")
epi.2by2(edu.strat.hs, method = "cross.sectional")
epi.2by2(edu.strat.sc, method = "cross.sectional")
epi.2by2(edu.strat.cg, method = "cross.sectional")

```

```{r}
### Stratifying by income ####
inc.strat.over <- with(df,
                       table(ment14d, mj30day, X_incomg))
inc.strat.sub15 <- with(subset(df, X_incomg == "< $15,000"),
                     table(ment14d, mj30day))
inc.strat.15 <- with(subset(df, X_incomg == "$15,000-$24,999"),
                     table(ment14d, mj30day))
inc.strat.25 <- with(subset(df, X_incomg == "$25,000-$34,999"),
                     table(ment14d, mj30day))
inc.strat.35 <- with(subset(df, X_incomg == "$35,000-$49,999"),
                     table(ment14d, mj30day))
inc.strat.50 <- with(subset(df, X_incomg == "> $50,000"),
                     table(ment14d, mj30day))

epi.2by2(inc.strat.over, method = "cross.sectional")
epi.2by2(inc.strat.sub15, method = "cross.sectional")
epi.2by2(inc.strat.15, method = "cross.sectional")
epi.2by2(inc.strat.25, method = "cross.sectional")
epi.2by2(inc.strat.35, method = "cross.sectional")
epi.2by2(inc.strat.50, method = "cross.sectional")

```

```{r}
#### Stratifying by race/eth. ####
race.strat.over <- with(df,
                        table(ment14d, mj30day, race))
race.strat.Asian <- with(subset(df, race == "Non-Hispanic Asian"),
                     table(ment14d, mj30day))
race.strat.B <- with(subset(df, race == "Non-Hispanic Black or African American"),
                     table(ment14d, mj30day))
race.strat.Hisp <- with(subset(df, race == "Hispanic, Latino/a, or Spanish origin"),
                     table(ment14d, mj30day))
race.strat.Mult <- with(subset(df, race == "Non-Hispanic two or more races"),
                     table(ment14d, mj30day))
race.strat.NatA <- with(subset(df, race == "Non-Hispanic Native American"),
                     table(ment14d, mj30day))
race.strat.othr <- with(subset(df, race == "Non-Hispanic Other race"),
                     table(ment14d, mj30day))
race.strat.PI <- with(subset(df, race == "Non-Hispanic Pacific Islander"),
                     table(ment14d, mj30day))
race.strat.Wte <- with(subset(df, race == "Non-Hispanic White"),
                     table(ment14d, mj30day))

epi.2by2(race.strat.over, method = "cross.sectional")
epi.2by2(race.strat.Asian, method = "cross.sectional")
epi.2by2(race.strat.B, method = "cross.sectional")
epi.2by2(race.strat.Hisp, method = "cross.sectional")
epi.2by2(race.strat.Mult, method = "cross.sectional")
epi.2by2(race.strat.NatA, method = "cross.sectional")
epi.2by2(race.strat.othr, method = "cross.sectional")
epi.2by2(race.strat.PI, method = "cross.sectional")
epi.2by2(race.strat.Wte, method = "cross.sectional")

```

```{r}
#### Stratifying by medcost ####
medcost.strat.over <- with(df,
                           table(ment14d, mj30day, medcost))
medcost.strat.y <- with(subset(df, medcost == "Yes"),
                        table(ment14d, mj30day))
medcost.strat.n <- with(subset(df, medcost == "No"),
                        table(ment14d, mj30day))

# STRATA COMPARISON NEEDS TO CHANGE 
# 14+ compared to no
# 14+ compared to 1-13


epi.2by2(medcost.strat.over, method = "cross.sectional")
epi.2by2(medcost.strat.y, method = "cross.sectional")
epi.2by2(medcost.strat.n, method = "cross.sectional")

# Stratifying by insurance
hc.strat.over <- with(df,
                      table(ment14d, mj30day, hlthpln1))
hc.strat.y <- with(subset(df, hlthpln1 == "Yes"),
                        table(ment14d, mj30day))
hc.strat.n <- with(subset(df, hlthpln1 == "No"),
                        table(ment14d, mj30day))

epi.2by2(hc.strat.over, method = "cross.sectional")
epi.2by2(hc.strat.y, method = "cross.sectional")
epi.2by2(hc.strat.n, method = "cross.sectional")

```

```{r}
#### Stratifying by tob. smk ####
smk.strat.over <- with(df,
                      table(ment14d, mj30day, curSmk))
smk.strat.y <- with(subset(df, curSmk == "Current smoker"),
                        table(ment14d, mj30day))
smk.strat.n <- with(subset(df, curSmk == "Non-smoker"),
                        table(ment14d, mj30day))

epi.2by2(smk.strat.over, method = "cross.sectional")
epi.2by2(smk.strat.y, method = "cross.sectional")
epi.2by2(smk.strat.n, method = "cross.sectional")

# Stratifying by alc. consumption 
alc.strat.over <- with(df,
                      table(ment14d, mj30day, curAlc))
alc.strat.pw <- with(subset(df, curAlc == "Within past week"),
                        table(ment14d, mj30day))
alc.strat.pm <- with(subset(df, curAlc == "Within past month"),
                        table(ment14d, mj30day))
alc.strat.none <- with(subset(df, curAlc == "None in past month"),
                        table(ment14d, mj30day))

epi.2by2(alc.strat.over, method = "cross.sectional")
epi.2by2(alc.strat.pw, method = "cross.sectional")
epi.2by2(alc.strat.pm, method = "cross.sectional")
epi.2by2(alc.strat.none, method = "cross.sectional")

```









