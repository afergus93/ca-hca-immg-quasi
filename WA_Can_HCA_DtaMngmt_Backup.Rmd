---
title: "WA_Can_HCA_DtaMngmt"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory
setwd("C:/wa-cannabis-hca")

# Clear workspace 
rm(list = ls())

# Load required libraries 
library(survey)
library(epiR)
library(tidyverse)
library(foreign)
library(haven)
library(table1)

```


```{r}
#### Load in the WA-BRFSS Data ####

# WRITING THE TEMP FILE IS ONLY NECCESARY IF YOU DO NOT HAVE THE FILE IN CSV FORMAT

# Read in the data as dta
temp <- read_dta('data/MAS_2011_2020_v2.dta') %>%
    subset(year > 2014 & year < 2020) # Years of interest given variable avail. are 2015 - 2019

# Find the proportion of observations in each year
tc <- table(temp$year) %>%
  prop.table() # get the proportion of each year's observations 

temp$'_llcpwt'[temp$year == 2015] <- temp$'_llcpwt'[temp$year == 2015] * tc[1] # Re-weighting 2015
temp$'_llcpwt'[temp$year == 2016] <- temp$'_llcpwt'[temp$year == 2016] * tc[2] # Re-weighting 2016
temp$'_llcpwt'[temp$year == 2017] <- temp$'_llcpwt'[temp$year == 2017] * tc[3] # Re-weighting 2017
temp$'_llcpwt'[temp$year == 2018] <- temp$'_llcpwt'[temp$year == 2018] * tc[4] # Re-weighting 2018
temp$'_llcpwt'[temp$year == 2019] <- temp$'_llcpwt'[temp$year == 2019] * tc[5] # Re-weighting 2019

# Re-write the file as a csv
write.csv(temp, 'data/WA_2015_2019_BRFSS.csv')

#Remove the dta file
rm(temp)

# Read in the newly created csv file for desired vars
full <- read.csv("data/WA_2015_2019_BRFSS.csv", stringsAsFactors = F) %>%
  select(year,
         zipcode,
         zipcode1,
         X_ststr,
         X_llcpwt,
         sex,
         X_ageg5yr,
         X_racegr3,
         educa,
         employ1,
         income2,
         X_smoker3,
         alcday5,
         menthlth,
         hlthpln1,
         medcost,
         mj30day
         ) %>%
  subset(X_ageg5yr < 10 | X_ageg5yr == 14) # Removing individuals over 65 due to Medicare eligibility 

# *Optional* Write to new file for memory efficiency 
write.csv(full, "data/WA_2015_2019_BRFSS_Sub.csv")
rm(list = ls())
df <- read.csv("data/WA_2015_2019_BRFSS_Sub.csv")
df$X <- NULL
summary(df)

```

```{r}
#### Assigning NA Values ####

# Assigning the values of 7 or 9 "refusal" to NA within sex variable
df$sex[df$sex == 7 | df$sex == 9] <- NA

# Assigning the value of 14 to NA within the age variable
df$X_ageg5yr[df$X_ageg5yr == 14] <- NA

# Assigning the value of 9 to NA within the race/Eth variable
df$X_racegr3[df$X_racegr3 == 9] <- NA

# Assigning the value of 9 to NA within the edu. variable
df$educa[df$educa == 9] <- NA

# Assigning the value of 9 to NA within the employment variable
df$employ1[df$employ1 == 9] <- NA

# Assigning the value of 77 and 99 to NA within the income variable
df$income2[df$income2 == 77 | df$income2 == 99] <- NA

# Assigning the value of 9 to NA within the mental health variable
df$menthlth[df$menthlth == 77 | df$menthlth == 99] <- NA

# Assigning the value of 7 and 9 to NA within the insurance variable
df$hlthpln1[df$hlthpln1 == 7 | df$hlthpln1 == 9] <- NA

# Assigning the value of 7 and 9 to NA within the medical cost variable
df$medcost[df$medcost == 7 | df$medcost == 9] <- NA

# Assigning the value of 7 and 9 to NA within the smoking variable
df$X_smoker3[df$X_smoker3 == 9] <- NA

# Assigning the value of 777 and 999 to NA within the alc. variable
df$alcday5[df$alcday5 == 777 | df$alcday5 == 999] <- NA

# Assigning the value of 77 and 99 to NA within the cannabis variable
df$mj30day[df$mj30day == 7 | df$mj30day == 9] <- NA

summary(df)

```

```{r}
#### Dropping All Observations Where MJ or HCA is NA ####

df <- df %>%
  filter(!is.na(mj30day) & !is.na(medcost) & !is.na(menthlth)) %>% # filter out any missingness associated with exposure/outcome
  rename(zipcodeTemp1 = zipcode, zipcodeTemp2 = zipcode1) %>% # Rename zipcode variables
  mutate(zipcode = coalesce(zipcodeTemp1, zipcodeTemp2)) %>% # Combine the zipcode variables across the two columns
  select(-c(zipcodeTemp1, zipcodeTemp2)) %>% # Drop old zipcode variables
  select(zipcode, everything()) # Move updated variable to the beginning of the dataframe

summary(df)

# Recoding mental health variable 
df$ment14d[df$menthlth == 88] <- 2 # No poor mental health days in the past 30 days
df$ment14d[df$menthlth >= 1 & df$menthlth <= 13] <- 2 # Between 1 and 13 days of poor mental health in past 30 days
df$ment14d[df$menthlth > 13 & df$menthlth <= 30] <- 1 # Between 13 and 30 days of poor mental health in past 30 days

# Recoding tobacco usage variable
df$curSmk[df$X_smoker3 == 1 | df$X_smoker3 == 2] <- 1 # Values 1 and 2 correspond to current smoker
df$curSmk[df$X_smoker3 == 3 | df$X_smoker3 == 4] <- 2 # Either a former smoker or never smoked
df$curSmk[is.na(df$X_smoker3)] <- NA

# Recoding the alc usage variable
df$curAlc[df$alcday5 > 100 & df$alcday5 < 231] <- 1 # Consumed alcohol in the past month
df$curAlc[df$alcday5 > 200 & df$alcday5 < 231] <- 2 # Consumed alcohol in the past month
df$curAlc[df$alcday5 == 888] <- 3 # Consumed no alcohol in past 30 days
df$curAlc[is.na(df$alcday5)] <- NA

# Recoding current smoker + current alc usage
df$curAlcSmk[df$curSmk == 1 & (df$curAlc == 1 | df$curAlc == 2)] <- 1
df$curAlcSmk[df$curSmk == 2 | df$curAlc == 3] <- 2
df$curAlcSmk[is.na(df$curAlc) | is.na(df$curSmk)] <- NA

```

```{r}
#### Factoring Variables #### 

# Gender Factor
df$sex <- factor(df$sex,
                 levels = c(1,2),
                 labels = c("Male", "Female"),
                 exclude = NULL)

# Education Factor
df$educa <- factor(df$educa,
                   levels = c(1,2,3,4,5,6),
                   labels = c("None or kindergarten only",
                              "Grades 1-8 (Elementary)",
                              "Grades 9-11 (Some high school)",
                              "High school graduate or GED",
                              "1-3 years College or technical school)",
                              "4+ years College (College graduate)"),
                   exclude = NULL)

# Race/Ethnicity Factor
df$X_racegr3 <- factor(df$X_racegr3,
                   levels = c(1,2,3,4,5),
                   labels = c("White only",
                              "Black only",
                              "Other race only",
                              "Multiracial",
                              "Hispanic"),
                   exclude = NULL)

# Age Factors
df$X_ageg5yr <- factor(df$X_ageg5yr, 
                       levels = c(1,2,3,4,5,6,7,8,9),
                       labels = c("Age 18 to 24", "Age 25 to 29",
                                  "Age 30 to 34", "Age 35 to 39",
                                  "Age 40 to 44", "Age 45 to 49",
                                  "Age 50 to 54", "Age 55 to 59",
                                  "Age 60 to 64"),
                       exclude = NULL)

# Employment Factors
df$employ1 <- factor(df$employ1,
                     levels = c(1,2,3,4,5,6,7,8),
                     labels = c("Employed for wages", "Self-employed",
                                "Out of work for 1 year or more", "Out of work < 1 year",
                                "A homemaker", "A student", "Retired", "Unable to work"),
                     exclude = NULL)

# Income Factors
df$income2 <- factor(df$income2,
                     levels = c(1,2,3,4,5,6,7,8),
                     labels = c("Less than $10,000", "Less than $15,000",
                                "Less than $20,000", "Less than $25,000",
                                "Less than $35,000", "Less than $50,000", 
                                "Less than $75,000", "$75,000 or more"),
                     exclude = NULL)

# Currant Smoker Factors
df$curSmk <- factor(df$curSmk,
                      levels = c(1,2),
                      labels = c("Yes", "No"),
                      exclude = NULL)

# Current Alc. Factors
df$curAlc <- factor(df$curAlc,
                      levels = c(1,2,3),
                      labels = c("Within past week", "Within past month", "None in past month"),
                      exclude = NULL)

# Current Alc. Factors
df$curAlcSmk <- factor(df$curAlcSmk,
                      levels = c(1,2),
                      labels = c("Yes", "No"),
                      exclude = NULL)

# Mental Health Factors
df$ment14d <- factor(df$ment14d,
                      levels = c(1,2),
                      labels = c("14+ days", "Less than 14 days"),
                      exclude = NULL)

# Health Insurance Factor
df$hlthpln1 <- factor(df$hlthpln1,
                      levels = c(1,2),
                      labels = c("Yes", "No"),
                      exclude = NULL)

# Med Cost Factor
df$medcost <- factor(df$medcost,
                      levels = c(1,2),
                      labels = c("Yes", "No"),
                      exclude = NULL)

# Cannabis Use Factor
df$mj30day <- factor(df$mj30day,
                      levels = c(1,2),
                      labels = c("Yes", "No"),
                      exclude = NULL)

```

```{r}

print(table1(~ X_ageg5yr + sex + educa + ment14d + medcost + hlthpln1 + curAlcSmk + X_racegr3 + income2 + employ1 | mj30day, data=df, overall = "Total"))

```






